<!-- Code originally from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v5.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>


<style>
    .tool-tip {
        position: absolute;
        padding: 8px;
        background: rgba(0, 0, 0, 0.8);
        color: bisque;
        border-radius: 2px;
        font-family: sans-serif;
        font-size: x-small;
        text-align: center;
    }

    .slice {
        stroke: white;
        stroke-width: 2px;
    }

    .line {
        stroke: black;
        fill: none;
        stroke-width: 1;
    }

    .label {
        font-family: sans-serif;
        font-size: x-small;
    }
</style>


<script>
    //----------------------------------------------------------

    // retained data
    var g_data = null;
    var g_title = null;

    // append the svg object to the body of the page
    var canvas = d3.select("#my_dataviz").append("svg");
    var chart = canvas.append("g");


    //----------------------------------------------------------
    const g_short_transition = 200;
    var g_tooltip = d3.select("#my_dataviz")
        .append("div")
            .attr('class', 'tool-tip')
            .style("opacity", "0");

    function TipShow(d) {
        g_tooltip
            .transition(g_short_transition)
            .style("opacity", "1");

        d3.select(this)
            .transition(g_short_transition)
            .style("opacity", 0.8)
    }

    function TipMove(d) {
        g_tooltip
            .html("<strong>" + d.data.category + ":</strong> <span style='color:white'>" + d.value + "</span>")
            .style("left", (d3.event.pageX + 15) + "px")
            .style("top", (d3.event.pageY) + "px");
    }

    function TipHide(d) {
        g_tooltip
            .transition(g_short_transition)
            .style("opacity", "0");

        d3.select(this)
            .transition(g_short_transition)
            .style("opacity", 1);
    }


    //----------------------------------------------------------
    function DrawChart(title, data, switch_time) {
        // set the dimensions and margins of the graph
        var margin = 30, min_window = 300;
        var window_width = Math.max(min_window, document.documentElement.clientWidth);
        var window_height = Math.max(min_window, document.documentElement.clientHeight);
        var radius = (Math.min(window_width, window_height) - (2 * margin)) / 2;

        canvas
            .attr("width", window_width - margin)
            .attr("height", window_height - margin);

        chart
            .attr("transform", "translate(" + window_width / 2 + "," + window_height / 2 + ")");

        // Compute the angle data for each slice in the pie
        var pie_generator = d3.pie()
            .startAngle(-0.75)
            .sort(null) // Do not sort by size
            .value(function (d) { return d.value; });

        var slice_data = pie_generator(data);

        // The "slice" generator
        var slice_generator = d3.arc()
          .innerRadius(radius * 0.5)
          .outerRadius(radius * 0.8);

        // Build the pie chart: each part of the pie is a path built using the arc function.
        chart.selectAll(".slice")
            .data(slice_data)
            .join('path')
                .on("mouseover", TipShow)
                .on("mousemove", TipMove)
                .on("mouseleave", TipHide)
                .transition()
                    .duration(switch_time)
                .attr("class", "slice")
                .attr('d', slice_generator)
                .attr('fill', function (d) { return d.data.selected ? "DarkOrange" : "DarkSlateBlue"; })

        // Arc for label line elbows
        var elbow_generator = d3.arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);

        // Add the polylines between chart and labels
        chart.selectAll('.line')
            .data(slice_data)
            .join('polyline')
                .transition()
                    .duration(switch_time)
                .attr("class", "line")
                .attr('points', function (d) {
                    var slice_centre = slice_generator.centroid(d);
                    var elbow = elbow_generator.centroid(d);
                    var text = elbow_generator.centroid(d);

                    // we need the angle to see if the X position will be at the extreme right or extreme left
                    var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    text[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1);
                    return [slice_centre, elbow, text];
                });

        // Add the labels
        chart.selectAll('.label')
            .data(slice_data)
            .join('text')
                .transition()
                    .duration(switch_time)
                .attr("class", "label")
                .text(function (d) { return d.data.category })
                .attr('transform', function (d) {
                    var pos = elbow_generator.centroid(d);
                    var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
                    return 'translate(' + pos + ')';
                })
                .style('text-anchor', function (d) {
                    var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    return (midangle < Math.PI ? 'start' : 'end')
                });
    }


    // draw the chart
    function CreateChart(title, json_text, switch_time) {
        g_data = JSON.parse(json_text);
        g_title = title;
        DrawChart(g_title, g_data, switch_time);
    }


    //----------------------------------------------------------
    function OnResize() {
        if (g_data !== null) {
            DrawChart(g_title, g_data, 0);
        }
    }

    window.addEventListener("resize", OnResize);


    //----------------------------------------------------------
    var model_text = '[{ "category": "P=[0.16]", "value": 1151, "selected": false }, { "category": "expire", "value": 1050, "selected": false }, { "category": "P=[0.15]", "value": 829, "selected": false }, { "category": "P=[0.17]", "value": 799, "selected": false }, { "category": "P=[0.09]", "value": 526, "selected": false }, { "category": "P=[0.18]", "value": 267, "selected": false }, { "category": "P=[0.08]", "value": 185, "selected": false }, { "category": "P=[0.19]", "value": 74, "selected": false }, { "category": "Other", "value": 252, "selected": false }]';
    CreateChart("Title", model_text, 1000);

</script>
