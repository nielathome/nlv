<!--
Copyright (C) Niel Clausen 2020. All rights reserved.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="polyfill.8.1.3.js"></script>
<script src="fetch.umd.3.0.0.js"></script>
<script src="d3.v5.min.js"></script>


<style>
    html, body {
        height: 100%;
        margin: 0;
    }

    .full-height {
        height: 99%;
        overflow: hidden;
    }

    .nodes text {
        font-family: sans-serif;
        font-size: x-small;
        pointer-events: none;
    }
</style>


<!-- Create a div for the SVG graph -->
<div id="graph" class="full-height"></div>


<script>
    //----------------------------------------------------------
    // here, node_id refers to the Python UI's node ID
    var g_nodes_table_node_id = 0,
        g_links_table_node_id = 0;

    function SetNodeId(node_id) {
    }

    function SetTableNodeIds(nodes_table_node_id, links_table_node_id) {
        g_nodes_table_node_id = nodes_table_node_id;
        g_links_table_node_id = links_table_node_id;
    }

    function CallPython(target_node_id, method, args_object) {
        args_json_text = JSON.stringify(args_object);
        args_encoded_text = btoa(args_json_text);
        cgi_text = "/" + target_node_id + "." + method + "?" + args_encoded_text;

        d3.json(cgi_text, function (error, results_json) {
            if (error)
                throw error;
        });
    }


    //----------------------------------------------------------
    function OnNodeClick(node) {
        if (!node.dragged) {
            CallPython(g_nodes_table_node_id, "OnChartSelection", { event_id: node.event_id, ctrl_key: d3.event.ctrlKey });
        }
    }

    function OnLinkClick(link) {
        CallPython(g_links_table_node_id, "OnChartSelection", { event_id: link.event_id, ctrl_key: d3.event.ctrlKey });
    }


    //----------------------------------------------------------

    // Style & behaviour configuration items. Override these
    // functions in your plugin. Don't rely on 'this'; the functions
    // are generally call'ed against a UI object.

    function Config(data) { }

    // fetch a node's ID; link elements use the ID to identify
    // the node's they connect
    Config.prototype.GetNodeId = function (node) {
        return node.event_id;
    }

    // set attributes on to a node (as a d3 selection)
    Config.prototype.StyleNode = function (selection) {
        selection
            .attr("r", 10)
            .attr("fill", "green")
            .attr("opacity", function (node) {
                return IsNodeSelected(node) ? 1.0 : 0.3;
            })
            .attr("style", "stroke: white; stroke-width: 1.5px;");
    }

    // set attributes on to a label (as a d3 selection)
    Config.prototype.StyleLabel = function (selection) {
        selection
            .text(function (node) {
                return node.title;
            })
            .attr("x", function (node) {
                return 15;
            })
            .attr("opacity", function (node) {
                return IsNodeSelected(node) ? 1.0 : 0.3;
            });
    }

    // set attributes on to a link (as a d3 selection)
    Config.prototype.StyleLink = function (selection) {
        selection
            .attr("opacity", function (node) {
                return IsLinkSelected(node) ? 1.0 : 0.3;
            })
            .attr("style", "stroke: #aaa;");
    }

    var g_configConstructor = Config;
    var g_config = null;

    function SetConfigConstructor(config_constructor) {
        g_configConstructor = config_constructor;
    }

    function SetupConfig(data) {
        g_config = new g_configConstructor(data);
    }

    
    //----------------------------------------------------------

    //
    // data to display - schema:
    //
    //  nodes[]
    //    event_id - number used by link structures to identify the node
    //    type - arbitrary type; nodes of the same type will normally the same style
    //    title - textual title displayed for the node
    //    size - arbitrary size; after normalising, the displayed diameter is proportional to this value
    //
    //  links[]
    //    source - initially node.event_id of source node; re-written to be reference to source node
    //    target - initially node.event_id of target node; re-written to be reference to target node
    //
    var g_data = null;

    //
    // display/layout configuration - schema:
    //
    var g_options = null;

    // retained data
    var g_simulation = null;
    var g_curZoom = 0;
    var g_curTransform = d3.zoomIdentity;

    // append the svg object to the body of the page
    var g_svg = d3.select("#graph")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%");

    var g_joined_links = null;
    var g_links_group = g_svg.append("g")
        .attr("class", "links");

    var g_joined_nodes = null;
    var g_joined_labels = null;
    var g_nodes_group = g_svg.append("g")
        .attr("class", "nodes");


    //----------------------------------------------------------

    // selection support
    var g_has_selection = false;
    var g_selected_nodes = new Set();
    var g_selected_links = new Set();

    function IsNodeSelected(node) {
        return !g_has_selection || g_selected_nodes.has(node.event_id);
    }

    function IsLinkSelected(id) {
        return !g_has_selection || g_selected_links.has(id);
    }


    //----------------------------------------------------------
    function GetWindowWidth() {
        return document.getElementById("graph").clientWidth;
    }

    function GetWindowHeight() {
        return document.getElementById("graph").clientHeight;
    }


    //----------------------------------------------------------
    function Layout() {
        const doTransition = (g_curZoom != g_curTransform.k);
        g_curZoom = g_curTransform.k;

        const ref_transition = d3.transition()
            .duration(250);

        (doTransition ? g_joined_links.transition(ref_transition) : g_joined_links)
            // map model coord system to SVG coord system
            .attr("x1", function (link) {
                return g_curTransform.applyX(link.source.x);
            })
            .attr("y1", function (link) {
                return g_curTransform.applyY(link.source.y);
            })
            .attr("x2", function (link) {
                return g_curTransform.applyX(link.target.x);
            })
            .attr("y2", function (link) {
                return g_curTransform.applyY(link.target.y);
            });

        function translate(item) {
            // map model coord system to SVG coord system
            const x = g_curTransform.applyX(item.x);
            const y = g_curTransform.applyY(item.y);
            return "translate(" + x + "," + y + ")";
        }

        (doTransition ? g_joined_nodes.transition(ref_transition) : g_joined_nodes)
            .attr("transform", translate);

        (doTransition ? g_joined_labels.transition(ref_transition) : g_joined_labels)
            .attr("transform", translate);
    }


    function DoCreateChart() {
        SetupConfig(g_data);
        g_curZoom = g_curTransform.k;

        g_svg
           .call(d3.zoom()
                .scaleExtent([1, 8])
                .wheelDelta(function wheelDelta() {
                    // d3.event here is the underlying WheelEvent
                    // fixed step per event; avoids magic numbers like this:
                    //  return -d3.event.deltaY * (d3.event.deltaMode === 1 ? 0.15 : d3.event.deltaMode ? 1 : 0.01);
                    return d3.event.deltaY < 0 ? 0.4 : -0.4;
                })
                .on("zoom", function() {
                    g_curTransform = d3.event.transform;
                    Layout();
                })
            );

        g_joined_links = g_links_group.selectAll("line")
          .data(g_data.links)
          .join("line")
            .call(g_config.StyleLink)
            .on("click", OnLinkClick)

        g_joined_nodes = g_nodes_group.selectAll("circle")
          .data(g_data.nodes)
          .join("circle")
            .call(g_config.StyleNode)
            .on("click", OnNodeClick)
            .call(d3.drag()
                .on("start", function (node) {
                    if (!d3.event.active)
                        g_simulation.alphaTarget(0.3).restart();
                    node.fx = node.x;
                    node.fy = node.y;
                    node.dragged = false;
                })
                .on("drag", function (node) {
                    // map SVG coord system back to model coord system
                    node.fx += d3.event.dx / g_curZoom;
                    node.fy += d3.event.dy / g_curZoom;
                    node.dragged = true;
                })
                .on("end", function (node) {
                    if (!d3.event.active)
                        g_simulation.alphaTarget(0);
                    node.fx = null;
                    node.fy = null;
                })
            );

        g_joined_labels = g_nodes_group.selectAll("text")
          .data(g_data.nodes)
          .join("text")
            .call(g_config.StyleLabel);
    }


    function DoSimulation() {
        centre_x = GetWindowWidth() / 2;
        centre_y = GetWindowHeight() / 2;

        g_simulation = d3.forceSimulation(g_data.nodes)
            .force("link", d3.forceLink(g_data.links)
                .id(g_config.GetNodeId)
                .distance(50)
            )
            .force("charge", d3.forceManyBody())
            .on("tick", Layout)
            .stop();

        if ("graph_is_disjoint" in g_options && g_options.graph_is_disjoint) {
            g_simulation
                .force("x", d3.forceX(centre_x))
                .force("y", d3.forceY(centre_y));
        }
        else {
            g_simulation
                .force("center", d3.forceCenter(centre_x, centre_y));
        }

        g_simulation.restart();
    }


    function CreateChart(data_json, options_json) {
        g_data = JSON.parse(data_json);
        g_options = JSON.parse(options_json);

        DoCreateChart();
        DoSimulation();
    }


    //----------------------------------------------------------
    function DoSetSelection() {
        g_joined_nodes.transition(250)
            .call(g_config.StyleNode);

        g_joined_labels.transition(250)
            .call(g_config.StyleLabel);

        g_joined_links.transition(250)
            .call(g_config.StyleLink);
    }


    function SetSelection(selection_json) {
        selection = JSON.parse(selection_json);

        g_selected_nodes = new Set();
        selection.nodes.forEach(function (event_id) {
            g_selected_nodes.add(event_id);
        });

        g_selected_links = new Set();
        selection.links.forEach(function (event_id) {
            g_selected_links.add(event_id);
        });

        g_has_selection = g_selected_nodes.size != 0 || g_selected_links.size != 0;

        DoSetSelection();
    }


</script>